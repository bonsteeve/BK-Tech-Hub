name: Deploy BK-Tech-Hub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------- FRONTEND ----------
      - name: Build React frontend
        working-directory: frontend
        run: |
          npm install --legacy-peer-deps
          npm run build

      - name: Upload frontend to public_html (SFTP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "frontend/build/*"
          target: "domains/bktechhub.com/public_html/"
          strip_components: 2

      # ---------- BACKEND ----------
      - name: Upload backend to server (SFTP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "backend/*"
          target: "/home/${{ secrets.SSH_USER }}/bk-tech-hub-backend"
          strip_components: 1

      - name: Upload backend env file
        run: |
          cat <<EOF > backend/.env
          MONGO_URL=${{ secrets.MONGO_URL }}
          DB_NAME=${{ secrets.DB_NAME }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          EOF

      - name: Upload backend .env (SFTP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "backend/.env"
          target: "/home/${{ secrets.SSH_USER }}/bk-tech-hub-backend"

